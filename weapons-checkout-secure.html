<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×“×•×— ×¦×œ× ××§×•×•×Ÿ - Online Armory Checkout System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Heebo', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success-check {
            animation: checkmark 0.6s ease-in-out;
        }
        
        @keyframes checkmark {
            0% { transform: scale(0) rotate(-45deg); }
            50% { transform: scale(1.2) rotate(-45deg); }
            100% { transform: scale(1) rotate(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-stone-100 to-stone-200 min-h-screen">
    
    <!-- Main Form Container -->
    <div id="formContainer" class="py-8 px-4">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8 fade-in">
                <div class="inline-block bg-green-700 text-white px-6 py-3 rounded-t-2xl shadow-lg">
                    <h1 class="text-3xl font-bold tracking-wide">×“×•×— ×¦×œ× ××§×•×•×Ÿ</h1>
                </div>
                <div class="bg-white rounded-b-2xl shadow-lg p-4 border-t-4 border-green-600">
                    <p class="text-stone-600 text-lg">Online Armory Checkout System</p>
                </div>
            </div>

            <!-- Form -->
            <form id="armoryForm" class="bg-white rounded-2xl shadow-2xl p-8 space-y-6 fade-in" style="animation-delay: 0.1s">
                
                <!-- Personal Number with Check Button -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-6 space-y-4">
                    <label for="personalNumber" class="block text-stone-700 font-bold mb-3 text-lg">
                        ××¡×¤×¨ ××™×©×™ <span class="text-red-600">*</span>
                    </label>
                    
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input
                            type="text"
                            id="personalNumber"
                            name="personalNumber"
                            maxlength="7"
                            class="flex-1 px-4 py-3 text-lg border-2 border-blue-300 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600"
                            placeholder="7 ×¡×¤×¨×•×ª"
                            required
                        />
                        <button
                            type="button"
                            id="checkExistingButton"
                            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-all duration-200 transform hover:scale-105 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:transform-none whitespace-nowrap sm:w-auto w-full"
                            disabled
                        >
                            ×‘×“×•×§
                        </button>
                    </div>
                    
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="personalNumber"></p>
                    
                    <p class="text-amber-700 text-sm flex items-start gap-2">
                        <span class="text-amber-600 font-bold">âš ï¸</span>
                        <span><strong>×—×©×•×‘:</strong> ×× × ×‘×“×•×§ ×”×× ×§×™×™××™× ×›×‘×¨ ×¤×¨×™×˜×™× ×©×—×ª××ª ×¢×œ×™×”×, ××—×¨×ª ×”××™×“×¢ ×™×™×“×¨×¡!</span>
                    </p>
                    
                    <!-- Status Messages -->
                    <div id="checkStatusExisting" class="hidden bg-green-50 border-2 border-green-400 rounded-lg p-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-green-700 font-bold">âœ“ × ××¦××• ×¤×¨×™×˜×™× ×§×™×™××™×! ×”×˜×•×¤×¡ ××•×œ× ×¢× ×”× ×ª×•× ×™× ×©×œ×š</p>
                        </div>
                    </div>
                    
                    <div id="checkStatusNew" class="hidden bg-blue-50 border-2 border-blue-400 rounded-lg p-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <p class="text-blue-700 font-bold">×œ× × ××¦××• ×¤×¨×™×˜×™× ×§×™×™××™× - ×–×• ×—×ª×™××” ×¨××©×•× ×”</p>
                        </div>
                    </div>
                    
                    <div id="checkStatusError" class="hidden bg-red-50 border-2 border-red-300 rounded-lg p-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-red-700 font-bold" id="checkErrorMessage">×©×’×™××” ×‘×‘×“×™×§×”</p>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <div class="border-t-2 border-stone-200"></div>

                <!-- Full Name -->
                <div>
                    <label for="fullName" class="block text-stone-700 font-bold mb-2 text-lg">
                        ×©× ××œ× <span class="text-red-600">*</span>
                    </label>
                    <input
                        type="text"
                        id="fullName"
                        name="fullName"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600"
                        placeholder="×©× ×¤×¨×˜×™ ×•××©×¤×—×”"
                        required
                    />
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="fullName"></p>
                </div>

                <!-- Phone -->
                <div>
                    <label for="phone" class="block text-stone-700 font-bold mb-2 text-lg">
                        ×˜×œ×¤×•×Ÿ <span class="text-red-600">*</span>
                    </label>
                    <input
                        type="tel"
                        id="phone"
                        name="phone"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600"
                        placeholder="05XXXXXXXX"
                        required
                    />
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="phone"></p>
                </div>

                <!-- Email -->
                <div>
                    <label for="email" class="block text-stone-700 font-bold mb-2 text-lg">
                        ××™×™×œ <span class="text-red-600">*</span>
                    </label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600"
                        placeholder="example@email.com"
                        required
                    />
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="email"></p>
                </div>

                <!-- Divider -->
                <div class="border-t-2 border-stone-200 my-6"></div>

                <!-- Unit -->
                <div>
                    <label for="unit" class="block text-stone-700 font-bold mb-2 text-lg">
                        ××¡×’×¨×ª <span class="text-red-600">*</span>
                    </label>
                    <select
                        id="unit"
                        name="unit"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200 bg-white"
                        required
                    >
                        <option value="">×‘×—×¨ ××¡×’×¨×ª</option>
                        <option value="×¤×œ×•×’×” ××³">×¤×œ×•×’×” ××³</option>
                        <option value="×¤×œ×•×’×” ×‘×³">×¤×œ×•×’×” ×‘×³</option>
                        <option value="×¤×œ×•×’×” ×’×³">×¤×œ×•×’×” ×’×³</option>
                        <option value="××¤×§×“×”">××¤×§×“×”</option>
                        <option value="× ×™×•×“">× ×™×•×“</option>
                        <option value="××—×¡×¨">××—×¡×¨</option>
                        <option value="××¤×’×´×“">××¤×’×´×“</option>
                    </select>
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="unit"></p>
                </div>

                <!-- Weapon Type -->
                <div>
                    <label for="weaponType" class="block text-stone-700 font-bold mb-2 text-lg">
                        ×¡×•×’ × ×©×§ <span class="text-red-600">*</span>
                    </label>
                    <select
                        id="weaponType"
                        name="weaponType"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200 bg-white"
                        required
                    >
                        <option value="">×‘×—×¨ ×¡×•×’ × ×©×§</option>
                        <option value="× ×’×‘">× ×’×‘</option>
                        <option value="M16">M16</option>
                        <option value="M4">M4</option>
                    </select>
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="weaponType"></p>
                </div>

                <!-- Weapon Number -->
                <div>
                    <label for="weaponNumber" class="block text-stone-700 font-bold mb-2 text-lg">
                        ××¡×¤×¨ × ×©×§ <span class="text-red-600">*</span>
                    </label>
                    <input
                        type="text"
                        id="weaponNumber"
                        name="weaponNumber"
                        maxlength="20"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200"
                        placeholder="××¡×¤×¨ ×¡×™×“×•×¨×™"
                        required
                    />
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="weaponNumber"></p>
                </div>

                <!-- Sight Type -->
                <div>
                    <label for="sightType" class="block text-stone-700 font-bold mb-2 text-lg">
                        ×¡×•×’ ×›×•×•× ×ª
                    </label>
                    <select
                        id="sightType"
                        name="sightType"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200 bg-white"
                    >
                        <option value="">×‘×—×¨ ×¡×•×’ ×›×•×•× ×ª</option>
                        <option value="×˜×¨×™×’×³">×˜×¨×™×’×³</option>
                        <option value="×œ×™××•×¨">×œ×™××•×¨</option>
                        <option value="×¤×’×™×•×Ÿ">×¤×’×™×•×Ÿ</option>
                        <option value="×–××‘×•×Ÿ">×–××‘×•×Ÿ</option>
                        <option value="m5">m5</option>
                    </select>
                </div>

                <!-- Sight Number -->
                <div>
                    <label for="sightNumber" class="block text-stone-700 font-bold mb-2 text-lg">
                        ××¡×¤×¨ ×›×•×•× ×ª
                    </label>
                    <input
                        type="text"
                        id="sightNumber"
                        name="sightNumber"
                        maxlength="20"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200"
                        placeholder="××¡×¤×¨ ×¡×™×“×•×¨×™"
                    />
                </div>

                <!-- Additional Sight Type -->
                <div>
                    <label for="additionalSightType" class="block text-stone-700 font-bold mb-2 text-lg">
                        ×¡×•×’ ×›×•×•× ×ª × ×•×¡×£
                    </label>
                    <select
                        id="additionalSightType"
                        name="additionalSightType"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200 bg-white"
                    >
                        <option value="">×‘×—×¨ ×¡×•×’ ×›×•×•× ×ª × ×•×¡×£</option>
                        <option value="×˜×¨×™×’×³">×˜×¨×™×’×³</option>
                        <option value="×œ×™××•×¨">×œ×™××•×¨</option>
                        <option value="×¤×’×™×•×Ÿ">×¤×’×™×•×Ÿ</option>
                        <option value="×–××‘×•×Ÿ">×–××‘×•×Ÿ</option>
                        <option value="m5">m5</option>
                    </select>
                </div>

                <!-- Additional Sight Number -->
                <div>
                    <label for="additionalSightNumber" class="block text-stone-700 font-bold mb-2 text-lg">
                        ××¡×¤×¨ ×›×•×•× ×ª × ×•×¡×£
                    </label>
                    <input
                        type="text"
                        id="additionalSightNumber"
                        name="additionalSightNumber"
                        maxlength="20"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200"
                        placeholder="××¡×¤×¨ ×¡×™×“×•×¨×™"
                    />
                </div>

                <!-- NVD Type -->
                <div>
                    <label for="nvdType" class="block text-stone-700 font-bold mb-2 text-lg">
                        ×¡×•×’ ×××¨×œ
                    </label>
                    <select
                        id="nvdType"
                        name="nvdType"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200 bg-white"
                    >
                        <option value="">×‘×—×¨ ×¡×•×’ ×××¨×œ</option>
                        <option value='×©×—"×¢'>×©×—"×¢</option>
                        <option value="×¢×›×‘×¨">×¢×›×‘×¨</option>
                        <option value="×¢×“×™">×¢×“×™</option>
                        <option value="×¢×™×“×•">×¢×™×“×•</option>
                        <option value="×§×™×¨×•">×§×™×¨×•</option>
                    </select>
                </div>

                <!-- NVD Number -->
                <div id="nvdNumberContainer" class="hidden">
                    <label for="nvdNumber" class="block text-stone-700 font-bold mb-2 text-lg">
                        ××¡×¤×¨ ×××¨×œ <span class="text-red-600">*</span>
                    </label>
                    <input
                        type="text"
                        id="nvdNumber"
                        name="nvdNumber"
                        maxlength="20"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200"
                        placeholder="××¡×¤×¨ ×¡×™×“×•×¨×™"
                    />
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="nvdNumber"></p>
                </div>

                <!-- Binoculars Checkbox -->
                <div class="flex items-center gap-3 p-4 bg-stone-50 rounded-xl">
                    <input
                        type="checkbox"
                        id="hasBinoculars"
                        name="hasBinoculars"
                        class="w-6 h-6 text-green-700 border-stone-300 rounded focus:ring-green-500"
                    />
                    <label for="hasBinoculars" class="text-stone-700 font-bold text-lg cursor-pointer">
                        ××©×§×¤×”
                    </label>
                </div>

                <!-- Compass Checkbox -->
                <div class="flex items-center gap-3 p-4 bg-stone-50 rounded-xl">
                    <input
                        type="checkbox"
                        id="hasCompass"
                        name="hasCompass"
                        class="w-6 h-6 text-green-700 border-stone-300 rounded focus:ring-green-500"
                    />
                    <label for="hasCompass" class="text-stone-700 font-bold text-lg cursor-pointer">
                        ××¦×¤×Ÿ
                    </label>
                </div>

                <!-- Zayin Checkbox -->
                <div class="flex items-center gap-3 p-4 bg-stone-50 rounded-xl">
                    <input
                        type="checkbox"
                        id="hasZayin"
                        name="hasZayin"
                        class="w-6 h-6 text-green-700 border-stone-300 rounded focus:ring-green-500"
                    />
                    <label for="hasZayin" class="text-stone-700 font-bold text-lg cursor-pointer">
                        ×¦×™×™×Ÿ
                    </label>
                </div>

                <!-- Zayin Number (hidden by default) -->
                <div id="zayinNumberContainer" class="hidden">
                    <label for="zayinNumber" class="block text-stone-700 font-bold mb-2 text-lg">
                        ××¡×¤×¨ ×¦×™×™×Ÿ <span class="text-red-600">*</span>
                    </label>
                    <input
                        type="text"
                        id="zayinNumber"
                        name="zayinNumber"
                        maxlength="20"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200"
                        placeholder="××¡×¤×¨ ×¡×™×“×•×¨×™"
                    />
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="zayinNumber"></p>
                </div>

                <!-- Pak Checkbox -->
                <div class="flex items-center gap-3 p-4 bg-stone-50 rounded-xl">
                    <input
                        type="checkbox"
                        id="hasPak"
                        name="hasPak"
                        class="w-6 h-6 text-green-700 border-stone-300 rounded focus:ring-green-500"
                    />
                    <label for="hasPak" class="text-stone-700 font-bold text-lg cursor-pointer">
                        ×¤×§
                    </label>
                </div>

                <!-- Pak Number (hidden by default) -->
                <div id="pakNumberContainer" class="hidden">
                    <label for="pakNumber" class="block text-stone-700 font-bold mb-2 text-lg">
                        ××¡×¤×¨ ×¤×§ <span class="text-red-600">*</span>
                    </label>
                    <input
                        type="text"
                        id="pakNumber"
                        name="pakNumber"
                        maxlength="20"
                        class="w-full px-4 py-3 text-lg border-2 border-stone-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-200 focus:border-green-600 transition-all duration-200"
                        placeholder="××¡×¤×¨ ×¡×™×“×•×¨×™"
                    />
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden error-message" data-field="pakNumber"></p>
                </div>

                <!-- Divider -->
                <div class="border-t-2 border-stone-200 my-6"></div>

                <!-- Legal Disclaimer -->
                <div class="bg-stone-50 border-r-4 border-green-700 p-4 rounded-lg mb-6">
                    <p class="text-stone-700 text-sm leading-relaxed">
                        <strong>×”×¦×”×¨×”:</strong> ×× ×™ ××¦×”×™×¨/×” ×‘×–××ª ×›×™ ×§×™×‘×œ×ª×™ ××ª ×”×¦×™×•×“ ×•×”×××¦×¢×™× ×”××¤×•×¨×˜×™× ×œ×¢×™×œ ×‘××¦×‘ ×ª×§×™×Ÿ ×•×ª×§× ×™. ×× ×™ ××ª×—×™×™×‘/×ª ×œ×©××•×¨ ×¢×œ ×”×¦×™×•×“ ×•×œ×”×—×–×™×¨×• ×‘××•×¢×“ ×•×‘××¦×‘ ×ª×§×™×Ÿ. ×™×“×•×¢ ×œ×™ ×›×™ ×× ×™ ××—×¨××™/×ª ×‘××•×¤×Ÿ ××™×©×™ ×¢×œ ×”×¦×™×•×“ ×©× ××¡×¨ ×œ×™ ×•×¢×œ×™ ×œ×“×•×•×— ××™×™×“×™×ª ×¢×œ ×›×œ × ×–×§, ×ª×§×œ×” ××• ××•×‘×“×Ÿ. ×›×œ ×”××™×“×¢ ×©××¡×¨×ª×™ × ×›×•×Ÿ ×•××“×•×™×§.
                    </p>
                </div>

                <!-- Signature -->
                <div>
                    <label class="block text-stone-700 font-bold mb-2 text-lg">
                        ×—×ª×™××” <span class="text-red-600">*</span>
                    </label>
                    <div class="border-2 border-stone-300 rounded-xl bg-white overflow-hidden" style="touch-action: none; -webkit-user-select: none; user-select: none;">
                        <canvas 
                            id="signatureCanvas" 
                            width="600" 
                            height="200"
                            class="w-full cursor-crosshair max-w-full"
                            style="display: block; touch-action: none;"
                        ></canvas>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button
                            type="button"
                            id="clearSignature"
                            class="px-4 py-2 bg-stone-500 hover:bg-stone-600 text-white rounded-lg text-sm transition-all duration-200"
                        >
                            × ×§×” ×—×ª×™××”
                        </button>
                        <p class="text-stone-500 text-sm flex items-center">×—×ª×•× ×‘××¦×‘×¢ ××• ×‘×¢×›×‘×¨</p>
                    </div>
                    <p class="text-red-600 text-sm mt-2 font-semibold hidden" id="signatureError">×™×© ×œ×—×ª×•× ×œ×¤× ×™ ×©×œ×™×—×”</p>
                </div>

                <!-- Submit Button -->
                <div class="pt-6">
                    <button
                        type="submit"
                        id="submitBtn"
                        class="w-full py-4 px-6 rounded-xl font-bold text-xl transition-all duration-200 shadow-lg bg-stone-300 text-stone-500 cursor-not-allowed"
                        disabled
                    >
                        ×©×œ×—
                    </button>
                    
                    <!-- Loader (hidden by default) -->
                    <div id="loader" class="hidden mt-4 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-green-700"></div>
                        <span class="mr-3 text-green-700 font-bold text-lg">×©×•×œ×—...</span>
                    </div>
                </div>

                <!-- Required fields note -->
                <p class="text-center text-stone-500 text-sm pt-4">
                    <span class="text-red-600">*</span> ×©×“×•×ª ×—×•×‘×”
                </p>
            </form>

            <!-- Footer -->
            <div class="text-center mt-8 text-stone-500 text-sm fade-in" style="animation-delay: 0.2s">
                <p>××¢×¨×›×ª ×“×™×’×™×˜×œ×™×ª ×œ× ×™×”×•×œ ×—×ª×™××•×ª ×¢×œ × ×©×§ ×•×××¦×¢×™ ×œ×—×™××”</p>
            </div>
        </div>
    </div>

    <!-- Success Message (Hidden by default) -->
    <div id="successContainer" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full">
            <div class="bg-white rounded-2xl shadow-2xl p-8 text-center border-t-4 border-green-700 fade-in">
                <div class="mb-6">
                    <div class="w-20 h-20 bg-green-700 rounded-full flex items-center justify-center mx-auto mb-4 success-check">
                        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-green-800 mb-2">×ª×•×“×”!</h2>
                </div>
                
                <div class="space-y-3 mb-8 text-right bg-stone-50 p-6 rounded-xl">
                    <p class="text-lg text-stone-700">×”×˜×•×¤×¡ × ×§×œ×˜ ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª</p>
                    <div class="border-t border-stone-300 pt-3 mt-3">
                        <p class="text-stone-600 font-semibold">××¡×¤×¨ ××™×©×™: <span class="text-green-700" id="displayPersonalNumber"></span></p>
                        <p class="text-stone-600 font-semibold">×©×: <span class="text-green-700" id="displayFullName"></span></p>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <p class="text-stone-500 text-sm">× ×™×ª×Ÿ ×œ×¡×’×•×¨ ×—×œ×•×Ÿ ×–×”</p>
                    <button
                        id="newFormBtn"
                        class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg"
                    >
                        ××œ× ×˜×•×¤×¡ × ×•×¡×£
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // AUTHENTICATION & CONFIGURATION
        // ============================================================
        
        const GOOGLE_SCRIPTURL = 'https://script.google.com/macros/s/AKfycbzNG9LHp0EB7N99OXoKlx10fWSQwUFnhnvIAvHaMBYI2LMpjnv6-mEGLj4tto7oDCtx9g/exec';
        const FORM_TYPE = 'weapons';
        
        // Initialize authentication
        const authClient = new SecureAuthClient(GOOGLE_SCRIPTURL);
        const authGuard = new AuthGuard(authClient, 'write');
        
        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Show loading overlay
            document.body.insertAdjacentHTML('afterbegin', `
                <div id="authLoadingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div style="text-align: center; color: white;">
                        <div style="width: 50px; height: 50px; border: 5px solid rgba(34, 197, 94, 0.3); border-top-color: #22c55e; border-radius: 50%; animation: authSpin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <p style="font-size: 18px; font-weight: bold;">××××ª ×–×”×•×ª...</p>
                    </div>
                </div>
                <style>
                    @keyframes authSpin {
                        to { transform: rotate(360deg); }
                    }
                </style>
            `);
            
            const isAuthenticated = await authGuard.checkAuth();
            
            if (isAuthenticated) {
                document.getElementById('authLoadingOverlay').remove();
                displayUserInfo();
            }
        });
        
        // Display logged-in user info
        function displayUserInfo() {
            const user = authClient.user;
            const formContainer = document.getElementById('formContainer');
            const firstChild = formContainer.querySelector('.max-w-2xl');
            
            firstChild.insertAdjacentHTML('afterbegin', `
                <div style="background: rgba(34, 197, 94, 0.1); padding: 12px 16px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; border: 2px solid rgba(34, 197, 94, 0.3);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">ğŸ‘¤</span>
                        <div>
                            <div style="font-weight: bold; color: #15803d; font-size: 16px;">${user.fullName || user.username}</div>
                            <div style="opacity: 0.7; font-size: 13px; color: #166534;">ğŸ”’ ×—×™×‘×•×¨ ×××•×‘×˜×—</div>
                        </div>
                    </div>
                    <button onclick="handleLogout()" style="background: #dc2626; color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                        ×”×ª× ×ª×§
                    </button>
                </div>
            `);
        }
        
        // Logout handler
        async function handleLogout() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                await authClient.logout();
            }
        }
        
        // ============================================================
        // ORIGINAL FORM CODE
        // ============================================================
        
        // Signature canvas setup
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        const clearBtn = document.getElementById('clearSignature');
        const signatureError = document.getElementById('signatureError');
        
        let isDrawing = false;
        let hasSignature = false;
        
        // Set canvas background to white
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Drawing settings
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', handleTouchStart);
        canvas.addEventListener('touchmove', handleTouchMove);
        canvas.addEventListener('touchend', stopDrawing);
        
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            ctx.beginPath();
            ctx.moveTo((e.clientX - rect.left) * scaleX, (e.clientY - rect.top) * scaleY);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            ctx.lineTo((e.clientX - rect.left) * scaleX, (e.clientY - rect.top) * scaleY);
            ctx.stroke();
            hasSignature = true;
            signatureError.classList.add('hidden');
            canvas.classList.remove('border-red-500');
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const touch = e.touches[0];
            ctx.beginPath();
            ctx.moveTo((touch.clientX - rect.left) * scaleX, (touch.clientY - rect.top) * scaleY);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const touch = e.touches[0];
            ctx.lineTo((touch.clientX - rect.left) * scaleX, (touch.clientY - rect.top) * scaleY);
            ctx.stroke();
            hasSignature = true;
            signatureError.classList.add('hidden');
            canvas.classList.remove('border-red-500');
        }
        
        clearBtn.addEventListener('click', () => {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;
            checkFormValidity();
        });
        
        // NVD Type change handler - show/hide NVD Number field
        const nvdTypeSelect = document.getElementById('nvdType');
        const nvdNumberContainer = document.getElementById('nvdNumberContainer');
        const nvdNumberInput = document.getElementById('nvdNumber');
        
        nvdTypeSelect.addEventListener('change', () => {
            if (nvdTypeSelect.value) {
                // Show and require NVD number
                nvdNumberContainer.classList.remove('hidden');
                nvdNumberInput.required = true;
            } else {
                // Hide and make optional
                nvdNumberContainer.classList.add('hidden');
                nvdNumberInput.required = false;
                nvdNumberInput.value = '';
                clearError('nvdNumber');
            }
            checkFormValidity();
        });
        
        // Zayin checkbox handler
        const hasZayinCheckbox = document.getElementById('hasZayin');
        const zayinNumberContainer = document.getElementById('zayinNumberContainer');
        const zayinNumberInput = document.getElementById('zayinNumber');
        
        hasZayinCheckbox.addEventListener('change', () => {
            if (hasZayinCheckbox.checked) {
                // Show and require zayin number
                zayinNumberContainer.classList.remove('hidden');
                zayinNumberInput.required = true;
            } else {
                // Hide and make optional
                zayinNumberContainer.classList.add('hidden');
                zayinNumberInput.required = false;
                zayinNumberInput.value = '';
                clearError('zayinNumber');
            }
            checkFormValidity();
        });
        
        // Pak checkbox handler
        const hasPakCheckbox = document.getElementById('hasPak');
        const pakNumberContainer = document.getElementById('pakNumberContainer');
        const pakNumberInput = document.getElementById('pakNumber');
        
        hasPakCheckbox.addEventListener('change', () => {
            if (hasPakCheckbox.checked) {
                // Show and require pak number
                pakNumberContainer.classList.remove('hidden');
                pakNumberInput.required = true;
            } else {
                // Hide and make optional
                pakNumberContainer.classList.add('hidden');
                pakNumberInput.required = false;
                pakNumberInput.value = '';
                clearError('pakNumber');
            }
            checkFormValidity();
        });
        
        // Personal number check functionality
        const personalNumberInput = document.getElementById('personalNumber');
        const checkExistingButton = document.getElementById('checkExistingButton');
        const checkStatusExisting = document.getElementById('checkStatusExisting');
        const checkStatusNew = document.getElementById('checkStatusNew');
        const checkStatusError = document.getElementById('checkStatusError');
        const checkErrorMessage = document.getElementById('checkErrorMessage');
        
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSe1FXGrJlUhDtZ1Sv0UVPh1Jt-l5JmnthwIzOX-zHP3W2EAxyz0UJutq7K4jAFgDO/exec';
        
        // Enable/disable check button based on input
        personalNumberInput.addEventListener('input', () => {
            const value = personalNumberInput.value.trim();
            checkExistingButton.disabled = value.length !== 7 || !/^\d{7}$/.test(value);
        });
        
        // Check for existing data using authenticated client
        checkExistingButton.addEventListener('click', async () => {
            const personalNumber = personalNumberInput.value.trim();
            
            if (!personalNumber || personalNumber.length !== 7) {
                checkStatusError.classList.remove('hidden');
                checkErrorMessage.textContent = '× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ××™×©×™ ×ª×§×™×Ÿ (7 ×¡×¤×¨×•×ª)';
                return;
            }
            
            // Hide all status messages
            checkStatusExisting.classList.add('hidden');
            checkStatusNew.classList.add('hidden');
            checkStatusError.classList.add('hidden');
            
            // Disable button and show loading
            checkExistingButton.disabled = true;
            checkExistingButton.textContent = 'â³ ×‘×•×“×§...';
            
            try {
                console.log('ğŸ” Checking existing data with auth...');
                
                // Use authenticated client
                const result = await authClient.getExistingData(personalNumber, FORM_TYPE);
                
                console.log('ğŸ“¥ Result:', result);
                
                if (result.success && result.data) {
                    // Fill form with existing data
                    fillFormWithData(result.data);
                    checkStatusExisting.classList.remove('hidden');
                } else if (result.success && !result.data) {
                    checkStatusNew.classList.remove('hidden');
                } else {
                    checkStatusError.classList.remove('hidden');
                    checkErrorMessage.textContent = result.error || '×©×’×™××” ×‘×‘×“×™×§×ª × ×ª×•× ×™×';
                }
                
                // Scroll to next field
                setTimeout(() => {
                    document.getElementById('fullName').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 500);
                
            } catch (error) {
                console.error('Error checking personal number:', error);
                checkStatusError.classList.remove('hidden');
                checkErrorMessage.textContent = '×©×’×™××” ×‘×‘×“×™×§×ª ×”××¡×¤×¨ ×”××™×©×™: ' + (error.message || '× ×¡×” ×©×•×‘');
            } finally {
                checkExistingButton.disabled = false;
                checkExistingButton.textContent = '×‘×“×•×§';
            }
        });
        
        // Fill form with existing data
        function fillFormWithData(data) {
            // Fill basic fields
            document.getElementById('fullName').value = data.fullName || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('unit').value = data.unit || '';
            document.getElementById('weaponType').value = data.weaponType || '';
            document.getElementById('weaponNumber').value = data.weaponNumber || '';
            
            // Fill sight fields based on which column has data
            if (data.trig) {
                document.getElementById('sightType').value = "×˜×¨×™×’×³";
                document.getElementById('sightNumber').value = data.trig;
            } else if (data.lior) {
                document.getElementById('sightType').value = "×œ×™××•×¨";
                document.getElementById('sightNumber').value = data.lior;
            } else if (data.pagion) {
                document.getElementById('sightType').value = "×¤×’×™×•×Ÿ";
                document.getElementById('sightNumber').value = data.pagion;
            } else if (data.zavon) {
                document.getElementById('sightType').value = "×–××‘×•×Ÿ";
                document.getElementById('sightNumber').value = data.zavon;
            } else if (data.m5) {
                document.getElementById('sightType').value = "m5";
                document.getElementById('sightNumber').value = data.m5;
            }
            
            // Fill additional sight (check remaining columns)
            const sightTypes = ['trig', 'lior', 'pagion', 'zavon', 'm5'];
            const mainSight = document.getElementById('sightType').value;
            
            for (let type of sightTypes) {
                const hebrewName = {trig: "×˜×¨×™×’×³", lior: "×œ×™××•×¨", pagion: "×¤×’×™×•×Ÿ", zavon: "×–××‘×•×Ÿ", m5: "m5"}[type];
                if (data[type] && hebrewName !== mainSight) {
                    document.getElementById('additionalSightType').value = hebrewName;
                    document.getElementById('additionalSightNumber').value = data[type];
                    break;
                }
            }
            
            // Fill NVD fields
            if (data.shacha) {
                document.getElementById('nvdType').value = '×©×—"×¢';
                document.getElementById('nvdNumber').value = data.shacha;
                nvdTypeSelect.dispatchEvent(new Event('change'));
            } else if (data.achbar) {
                document.getElementById('nvdType').value = "×¢×›×‘×¨";
                document.getElementById('nvdNumber').value = data.achbar;
                nvdTypeSelect.dispatchEvent(new Event('change'));
            } else if (data.adi) {
                document.getElementById('nvdType').value = "×¢×“×™";
                document.getElementById('nvdNumber').value = data.adi;
                nvdTypeSelect.dispatchEvent(new Event('change'));
            } else if (data.ido) {
                document.getElementById('nvdType').value = "×¢×™×“×•";
                document.getElementById('nvdNumber').value = data.ido;
                nvdTypeSelect.dispatchEvent(new Event('change'));
            } else if (data.kiro) {
                document.getElementById('nvdType').value = "×§×™×¨×•";
                document.getElementById('nvdNumber').value = data.kiro;
                nvdTypeSelect.dispatchEvent(new Event('change'));
            }
            
            // Fill checkboxes
            document.getElementById('hasBinoculars').checked = data.binoculars === "1";
            document.getElementById('hasCompass').checked = data.compass === "1";
            
            // Fill zayin
            if (data.zayin) {
                document.getElementById('hasZayin').checked = true;
                document.getElementById('zayinNumber').value = data.zayin;
                hasZayinCheckbox.dispatchEvent(new Event('change'));
            }
            
            // Fill pak
            if (data.pak) {
                document.getElementById('hasPak').checked = true;
                document.getElementById('pakNumber').value = data.pak;
                hasPakCheckbox.dispatchEvent(new Event('change'));
            }
            
            // Trigger form validity check
            checkFormValidity();
        }
        
        // Form validation and handling
        const form = document.getElementById('armoryForm');
        const submitBtn = document.getElementById('submitBtn');
        const formContainer = document.getElementById('formContainer');
        const successContainer = document.getElementById('successContainer');
        const newFormBtn = document.getElementById('newFormBtn');

        // Validation functions
        function validateFullName(name) {
            const words = name.trim().split(/\s+/);
            return words.length >= 2 && /^[\u0590-\u05FFa-zA-Z\s]+$/.test(name);
        }

        function validatePersonalNumber(number) {
            return /^\d{7}$/.test(number);
        }

        function validatePhone(phone) {
            return /^05\d{8}$/.test(phone.replace(/[-\s]/g, ''));
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showError(fieldName, message) {
            const input = document.getElementById(fieldName);
            const errorMsg = document.querySelector(`[data-field="${fieldName}"]`);
            
            if (!input) return; // Field doesn't exist
            
            input.classList.remove('border-stone-300', 'focus:border-green-600');
            input.classList.add('border-red-500', 'bg-red-50', 'focus:border-red-500', 'focus:ring-red-200');
            
            if (errorMsg) {
                errorMsg.textContent = message;
                errorMsg.classList.remove('hidden');
            }
        }

        function clearError(fieldName) {
            const input = document.getElementById(fieldName);
            const errorMsg = document.querySelector(`[data-field="${fieldName}"]`);
            
            if (!input) return; // Field doesn't exist
            
            input.classList.remove('border-red-500', 'bg-red-50', 'focus:border-red-500', 'focus:ring-red-200');
            input.classList.add('border-stone-300', 'focus:border-green-600');
            
            if (errorMsg) {
                errorMsg.classList.add('hidden');
            }
        }

        function checkFormValidity() {
            const fullName = document.getElementById('fullName').value;
            const personalNumber = document.getElementById('personalNumber').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const unit = document.getElementById('unit').value;
            const weaponType = document.getElementById('weaponType').value;
            const weaponNumber = document.getElementById('weaponNumber').value;
            
            // Check if NVD number is required (only if NVD type is selected)
            const nvdType = document.getElementById('nvdType').value;
            const nvdNumber = document.getElementById('nvdNumber').value;
            const nvdNumberRequired = nvdType && !nvdNumber;
            
            // Check if zayin number is required (only if zayin checkbox is checked)
            const hasZayin = document.getElementById('hasZayin').checked;
            const zayinNumber = document.getElementById('zayinNumber').value;
            const zayinNumberRequired = hasZayin && !zayinNumber;
            
            // Check if pak number is required (only if pak checkbox is checked)
            const hasPak = document.getElementById('hasPak').checked;
            const pakNumber = document.getElementById('pakNumber').value;
            const pakNumberRequired = hasPak && !pakNumber;

            // Don't require signature for button enabling - only validate on submit
            const isValid = fullName && personalNumber && phone && email && unit && weaponType && weaponNumber && !nvdNumberRequired && !zayinNumberRequired && !pakNumberRequired;

            if (isValid) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-stone-300', 'text-stone-500', 'cursor-not-allowed');
                submitBtn.classList.add('bg-green-700', 'hover:bg-green-800', 'text-white', 'cursor-pointer', 'transform', 'hover:scale-105', 'hover:shadow-2xl');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-stone-300', 'text-stone-500', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-green-700', 'hover:bg-green-800', 'text-white', 'cursor-pointer', 'transform', 'hover:scale-105', 'hover:shadow-2xl');
            }
        }

        // Add input event listeners
        ['fullName', 'personalNumber', 'phone', 'email', 'unit', 'weaponType', 'weaponNumber', 'nvdNumber', 'zayinNumber', 'pakNumber'].forEach(fieldName => {
            const input = document.getElementById(fieldName);
            input.addEventListener('input', () => {
                clearError(fieldName);
                checkFormValidity();
            });
            
            // For select fields, also listen to change event
            if (input.tagName === 'SELECT') {
                input.addEventListener('change', () => {
                    clearError(fieldName);
                    checkFormValidity();
                });
            }
        });

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear all errors
            ['fullName', 'personalNumber', 'phone', 'email', 'unit', 'weaponType', 'weaponNumber', 'nvdNumber', 'zayinNumber', 'pakNumber'].forEach(clearError);

            let hasErrors = false;
            let firstErrorField = null;

            // Validate full name
            const fullName = document.getElementById('fullName').value;
            if (!fullName) {
                showError('fullName', '×©×“×” ×—×•×‘×”');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'fullName';
            } else if (!validateFullName(fullName)) {
                showError('fullName', '×™×© ×œ×”×–×™×Ÿ ×©× ×¤×¨×˜×™ ×•××©×¤×—×” (××™× ×™××•× 2 ××™×œ×™×)');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'fullName';
            }

            // Validate personal number
            const personalNumber = document.getElementById('personalNumber').value;
            if (!personalNumber) {
                showError('personalNumber', '×©×“×” ×—×•×‘×”');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'personalNumber';
            } else if (!validatePersonalNumber(personalNumber)) {
                showError('personalNumber', '××¡×¤×¨ ××™×©×™ ×—×™×™×‘ ×œ×”×›×™×œ ×‘×“×™×•×§ 7 ×¡×¤×¨×•×ª');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'personalNumber';
            }

            // Validate phone
            const phone = document.getElementById('phone').value;
            if (!phone) {
                showError('phone', '×©×“×” ×—×•×‘×”');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'phone';
            } else if (!validatePhone(phone)) {
                showError('phone', '××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ (×¤×•×¨××˜: 05XXXXXXXX)');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'phone';
            }

            // Validate email
            const email = document.getElementById('email').value;
            if (!email) {
                showError('email', '×©×“×” ×—×•×‘×”');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'email';
            } else if (!validateEmail(email)) {
                showError('email', '×›×ª×•×‘×ª ××™×™×œ ×œ× ×ª×§×™× ×”');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'email';
            }

            // Validate unit
            const unit = document.getElementById('unit').value;
            if (!unit) {
                showError('unit', '×©×“×” ×—×•×‘×”');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'unit';
            }

            // Validate weapon type
            const weaponType = document.getElementById('weaponType').value;
            if (!weaponType) {
                showError('weaponType', '×©×“×” ×—×•×‘×”');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'weaponType';
            }

            // Validate weapon number
            const weaponNumber = document.getElementById('weaponNumber').value;
            if (!weaponNumber) {
                showError('weaponNumber', '×©×“×” ×—×•×‘×”');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'weaponNumber';
            }

            // Validate NVD number (only if NVD type is selected)
            const nvdType = document.getElementById('nvdType').value;
            const nvdNumber = document.getElementById('nvdNumber').value;
            if (nvdType && !nvdNumber) {
                showError('nvdNumber', '×©×“×” ×—×•×‘×” ×›××©×¨ × ×‘×—×¨ ×¡×•×’ ×××¨×œ');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'nvdNumber';
            }

            // Validate zayin number (only if zayin checkbox is checked)
            const hasZayin = document.getElementById('hasZayin').checked;
            const zayinNumber = document.getElementById('zayinNumber').value;
            if (hasZayin && !zayinNumber) {
                showError('zayinNumber', '×©×“×” ×—×•×‘×” ×›××©×¨ × ×‘×—×¨ ×¦×™×™×Ÿ');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'zayinNumber';
            }

            // Validate pak number (only if pak checkbox is checked)
            const hasPak = document.getElementById('hasPak').checked;
            const pakNumber = document.getElementById('pakNumber').value;
            if (hasPak && !pakNumber) {
                showError('pakNumber', '×©×“×” ×—×•×‘×” ×›××©×¨ × ×‘×—×¨ ×¤×§');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'pakNumber';
            }

            // Validate signature
            if (!hasSignature) {
                signatureError.textContent = '×™×© ×œ×—×ª×•× ×œ×¤× ×™ ×©×œ×™×—×”';
                signatureError.classList.remove('hidden');
                canvas.classList.add('border-red-500');
                hasErrors = true;
                if (!firstErrorField) firstErrorField = 'signatureCanvas';
            }

            if (hasErrors) {
                // Scroll to first error field
                if (firstErrorField) {
                    const errorElement = document.getElementById(firstErrorField);
                    errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Focus on the field if it's an input
                    if (errorElement.tagName === 'INPUT' || errorElement.tagName === 'SELECT') {
                        setTimeout(() => errorElement.focus(), 500);
                    }
                }
                return;
            }

            // Disable button and show loader
            submitBtn.disabled = true;
            submitBtn.classList.remove('bg-green-700', 'hover:bg-green-800', 'cursor-pointer', 'transform', 'hover:scale-105');
            submitBtn.classList.add('bg-stone-300', 'text-stone-500', 'cursor-not-allowed');
            submitBtn.textContent = '×©×•×œ×—...';
            
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');

            // Prepare data object
            const signatureData = canvas.toDataURL('image/png');
            const signatureSize = signatureData.length;
            console.log('ğŸ–Šï¸ Signature size:', signatureSize, 'bytes (~' + Math.round(signatureSize / 1024) + 'KB)');
            
            if (signatureSize > 5000000) { // 5MB
                alert('×”×—×ª×™××” ×’×“×•×œ×” ××“×™. ×× × × ×¡×” ×œ×—×ª×•× ×©×•×‘.');
                submitBtn.disabled = false;
                submitBtn.classList.add('bg-green-700', 'hover:bg-green-800', 'cursor-pointer', 'transform', 'hover:scale-105');
                submitBtn.classList.remove('bg-stone-300', 'text-stone-500', 'cursor-not-allowed');
                submitBtn.textContent = '×©×œ×—';
                loader.classList.add('hidden');
                return;
            }
            
            const data = {
                fullName: fullName,
                personalNumber: personalNumber,
                phone: phone,
                email: document.getElementById('email').value,
                unit: document.getElementById('unit').value,
                weaponType: document.getElementById('weaponType').value,
                weaponNumber: document.getElementById('weaponNumber').value,
                sightType: document.getElementById('sightType').value,
                sightNumber: document.getElementById('sightNumber').value,
                additionalSightType: document.getElementById('additionalSightType').value,
                additionalSightNumber: document.getElementById('additionalSightNumber').value,
                nvdType: document.getElementById('nvdType').value,
                nvdNumber: document.getElementById('nvdNumber').value,
                hasBinoculars: document.getElementById('hasBinoculars').checked,
                hasCompass: document.getElementById('hasCompass').checked,
                hasZayin: document.getElementById('hasZayin').checked,
                zayinNumber: document.getElementById('zayinNumber').value,
                hasPak: document.getElementById('hasPak').checked,
                pakNumber: document.getElementById('pakNumber').value,
                signature: signatureData,
                timestamp: new Date().toISOString()
            };
            
            console.log('ğŸ“¤ Submitting data with auth:', {
                ...data,
                signature: 'BASE64_DATA_' + signatureSize + '_BYTES'
                });
            
            try {
                console.log('â³ Submitting via authClient...');
                
                // Submit using authenticated client
                const result = await authClient.submitData(data, FORM_TYPE);
                
                console.log('âœ… Submit result:', result);
                
                if (result.success) {
                    console.log('âœ… Submission successful');
                    
                    // Wait a bit to ensure completion
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }catch (error) {
                console.error('âŒ Submit error:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                
                // Hide loader
                loader.classList.add('hidden');
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-stone-300', 'text-stone-500', 'cursor-not-allowed');
                submitBtn.classList.add('bg-green-700', 'hover:bg-green-800', 'cursor-pointer', 'transform', 'hover:scale-105');
                submitBtn.textContent = '×©×œ×—';
                
                // Show error message
                let errorMessage = '×©×’×™××” ×‘×©×œ×™×—×ª ×”× ×ª×•× ×™×';
                
                if (error.message === 'Session expired') {
                    errorMessage = '×¤×’ ×ª×•×§×£ ×”×”×ª×—×‘×¨×•×ª. ×× × ×”×ª×—×‘×¨ ×©×•×‘.';
                    setTimeout(() => authClient.logout(), 2000);
                } else if (error.message === 'Insufficient permissions') {
                    errorMessage = '××™×Ÿ ×œ×š ×”×¨×©××” ×œ×‘×¦×¢ ×¤×¢×•×œ×” ×–×•.';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                alert(errorMessage);
                return; // Don't show success message
            }

            // Hide loader
            loader.classList.add('hidden');

            // Show success message
            document.getElementById('displayFullName').textContent = data.fullName;
            document.getElementById('displayPersonalNumber').textContent = data.personalNumber;
            
            formContainer.classList.add('hidden');
            successContainer.classList.remove('hidden');
        });

        // New form button
        newFormBtn.addEventListener('click', () => {
            form.reset();
            ['fullName', 'personalNumber', 'phone', 'email', 'unit', 'weaponType', 'weaponNumber', 'nvdNumber', 'zayinNumber', 'pakNumber'].forEach(clearError);
            
            // Hide NVD number field
            nvdNumberContainer.classList.add('hidden');
            nvdNumberInput.required = false;
            
            // Hide zayin number field
            zayinNumberContainer.classList.add('hidden');
            zayinNumberInput.required = false;
            
            // Hide pak number field
            pakNumberContainer.classList.add('hidden');
            pakNumberInput.required = false;
            
            // Clear signature
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;
            signatureError.classList.add('hidden');
            
            // Reset submit button
            submitBtn.textContent = '×©×œ×—';
            
            checkFormValidity();
            successContainer.classList.add('hidden');
            formContainer.classList.remove('hidden');
            window.scrollTo(0, 0);
        });

        // Initial check
        checkFormValidity();
    </script>

    <!-- Auth Client Library -->
    <script src="auth-client.js"></script>
</body>
</html>